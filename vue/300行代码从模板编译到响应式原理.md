
#### å¯¼è¯»

ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€å¯ç”¨æ€§é«˜çš„æ¡†æ¶ï¼Œå…¶æºç ä¸€å®šåŒ…å«äº†å¾ˆå¤šè¾¹ç•Œæƒ…å†µçš„å¤„ç†ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å æ¯”åè€Œå¾ˆå°‘ã€‚åˆå­¦è€…å¦‚æœç›´æ¥è¯»æºç ï¼Œå¾ˆå®¹æ˜“è¿·å¤±åœ¨ç¹ççš„ç‰¹æ®Šæƒ…å†µå¤„ç†ä¸­ï¼Œå¾ˆéš¾çœŸæ­£æŒæ¡æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½å®ç°åŸç†ã€‚

è¿™é‡Œæˆ‘å°† vue æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ‹†åˆ†å‡ºæ¥ï¼Œä¸€æ­¥æ­¥æ‹†è§£å…¶å®ç°æ–¹å¼ï¼Œå®ç°ä¸€ä¸ªä»æ¨¡æ¿ç¼–è¯‘åˆ°æ•°æ®å“åº”å¼çš„ç®€æ˜“æ¡†æ¶ï¼Œæ¢è®¨ vue çš„æ ¸å¿ƒåŸç† ~

ç‚¹å‡»è¿›å…¥ ğŸ”— https://jsbin.com/niyapom  , å…ˆä½“éªŒä¸€ä¸‹ç®€æ˜“ vue çš„åŠŸèƒ½ã€‚


<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a3f9a6228394dd69cc3b1882bea21e2~tplv-k3u1fbpfcp-zoom-1.image" width="600">


ç®€æ˜“æ¡†æ¶ä¸ vue ä¿æŒä¸€è‡´çš„è¯­æ³•ã€‚ä¸‹è¿°ä»£ç å¼•å…¥ myVue è„šæœ¬ï¼Œåˆ›å»º vue å®ä¾‹ï¼Œæ”¯æŒtemplateï¼Œdataï¼Œmethods ç­‰é€‰é¡¹ï¼Œä¸»è¦åŠŸèƒ½æœ‰æ¨¡æ¿ç¼–è¯‘ã€æ•°æ®å“åº”å¼ã€äº‹ä»¶ç»‘å®šç­‰ã€‚


```js
const vm = new myVue({
  data() {
    return {
      num1: 1,
      num2: 2,
    }
  },
  template: `<div class="container" style="margin: 10px;">
    <div class="btns">
      <span>num1: {{num1}}</span>
      <button @click="addNum1">add</button>
      <button @click="reduceNum1">reduce</button>
    </div>
    <div class="btns">
      <span>num2: {{num2}}</span>
      <button @click="addNum2">add</button>
      <button @click="reduceNum2">reduce</button>
    </div>
    <div>num1 x num2 = {{num1*num2}}</div>
    <div>num1 + num2 = {{num1+num2}}</div>
  </div>`,
  el: '#app',
  methods: {
    addNum1() {
      this.num1 += 1
    },
    reduceNum1() {
      this.num1 -= 1
    },
    addNum2() {
      this.num2 += 1
    },
    reduceNum2() {
      this.num2 -= 1
    }
  }
})
```



----
#### æµç¨‹æ¦‚è¿°

äº†è§£äº†å®ç°çš„åŠŸèƒ½èŒƒå›´åï¼Œæˆ‘ä»¬å¤§è‡´çœ‹ä¸€ä¸‹åŸºæœ¬æ€è·¯ã€‚å…¶å·¥ä½œæµç¨‹æ¦‚è¿°å¦‚ä¸‹ï¼š

1ã€é€šè¿‡ template é€‰é¡¹è·å–**æ¨¡æ¿å­—ç¬¦ä¸²**ï¼ˆå½¢å¦‚ï¼š `<ul><li>åˆ—è¡¨1</li><li>åˆ—è¡¨2</li></ul>`  ï¼Œå³ä¸€ä¸ª String å½¢å¼çš„ HTMLï¼‰

2ã€å°†æ¨¡æ¿å­—ç¬¦ä¸²è§£æä¸º AST æ ‘ï¼Œå»ºç«‹**è™šæ‹Ÿ DOM**
- è™šæ‹Ÿ DOM çš„ç»“æ„ç®€åŒ–äº†ï¼Œåªä¿ç•™ tagName ã€children å’Œ attributes å±æ€§ï¼ŒtagName è¡¨ç¤º DOM çš„æ ‡ç­¾åï¼Œchildren ä¸ºå­èŠ‚ç‚¹åˆ—è¡¨ï¼Œ attributes è¡¨ç¤º html ä¸Šå±æ€§ã€‚
- vue æºç æµç¨‹ä¸ºï¼šhtmlå­—ç¬¦ä¸² -> ast æ ‘ -> render æ–¹æ³• -> vnode(è™šæ‹Ÿdom) -> çœŸå® domã€‚è€Œè¿™é‡Œåªä¿ç•™ä¸‰ä¸ªç¯èŠ‚ï¼šhtmlå­—ç¬¦ä¸² -> vnode -> çœŸå® domã€‚
  
3ã€æ ¹æ®è™šæ‹Ÿ DOM åˆ›å»º**çœŸå® DOM æ ‘**ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šçš„ HTML èŠ‚ç‚¹ä¸Šã€‚
- é€šè¿‡ document.createElement  ã€document.createTextNode  ç­‰ API åˆ›å»ºçœŸå®çš„ DOM æ ‘
- åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå°† classã€style ç­‰å±æ€§æ·»åŠ åˆ° DOM èŠ‚ç‚¹ä¸­ï¼Œå¹¶æ³¨å†Œ @ å…³é”®å­—å¯¹åº”çš„äº‹ä»¶

4ã€å°† **data æ¸²æŸ“**åˆ°æ¨¡æ¿ä¸­
- è¯†åˆ« HTML å…ƒç´ ä¸­çš„ mustache è¯­æ³• `(å³æ¨¡æ¿ä¸­çš„ {{xxx}})`
- å°† mustache è¯­æ³•æ›¿æ¢ä¸ºå¯¹åº” data çš„å€¼:æ”¯æŒ mustache ä¸­å¯¹è±¡å±æ€§è·å–ã€è¡¨è¾¾å¼æ‰§è¡Œç­‰;è·å– data ä¸­çš„å€¼æ—¶ï¼Œæ·»åŠ å¯¹åº” key çš„ä¾èµ–
    
5ã€å®ç° data **å“åº”å¼æ›´æ–°**
- åœ¨æ•°æ®æ›´æ–°æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰ä¾èµ–æ–¹ï¼Œæ›´æ–°å¯¹åº”çš„è™šæ‹Ÿ DOM èŠ‚ç‚¹çš„å†…å®¹
  
  
---- 
  
**ä¸‹é¢é‡ç‚¹è§£æäº”ä¸ªæ­¥éª¤çš„å®ç°æ–¹å¼~**

#### Step 1ï¼šè·å–æ¨¡æ¿å­—ç¬¦ä¸²
é¦–å…ˆè·å– æ¨¡æ¿å­—ç¬¦ä¸²ã€‚æ¨¡æ¿å­—ç¬¦ä¸²è¿™é‡Œæä¾›ä¸¤ç§å½¢å¼ï¼Œä¸€ç§æ˜¯ type="x-template" çš„ script æ ‡ç­¾ï¼Œä¸€ç§æ˜¯ç›´æ¥è¾“å…¥ å­—ç¬¦ä¸²æ¨¡å¼ã€‚è¿™ä¸ªç¯èŠ‚æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„æ¨¡æ¿

```html
<!-- æ–¹å¼ä¸€ï¼šscript æ ‡ç­¾æ¨¡å¼ -->
<!-- åœ¨ html ä¸­ï¼š -->
<script type="text/x-template" id="template">
  <div class="container" style="margin: 10px;">
    <div class="btns">
      <span>num1: {{num1}}</span>
      <button @click="addNum1">add</button>
      <button @click="reduceNum1">reduce</button>
    </div>
    <div class="btns">
      <span>num2: {{num2}}</span>
      <button @click="addNum2">add</button>
      <button @click="reduceNum2">reduce</button>
    </div>
    <div>num1 x num2 = {{num1*num2}}</div>
    <div>num1 + num2 = {{num1+num2}}</div>
  </div>
</script>
<script>
    <!-- è·å– script å…ƒç´ ï¼Œè·å–å…¶ä¸­æ–‡æœ¬å†…å®¹ -->
    const tmpl = document.querySelector(options.template).innerHTML
</script>
<!-- æ–¹å¼äºŒï¼šçº¯å­—ç¬¦ä¸²å½¢å¼ -->
<script>
<!-- template å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç›´æ¥è·å– -->
const tmpl = options.template
</script>
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé€šè¿‡è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²ã€‚æ³¨æ„ï¼Œè¿™å¹¶ä¸æ˜¯ HTMLï¼Œåªæ˜¯ä¸€äº›æ¢äº†è¡Œçš„å­—ç¬¦ä¸²ã€‚


<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02e3063ef2474be2b08f84b0ed389672~tplv-k3u1fbpfcp-zoom-1.image" width="600"/>


#### Step 2ï¼šä»æ¨¡æ¿å­—ç¬¦ä¸² åˆ° è™šæ‹Ÿ DOM

åˆ†æä¸€æ³¢~

å…ˆä»è¾“å…¥å’Œè¾“å‡ºçš„è§’åº¦åˆ†æã€‚å…ˆä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

```js
// è¾“å…¥ä¸º
const tmpl = `<ul class="list"><li>åˆ—è¡¨1</li><li>åˆ—è¡¨2</li></ul>`
// å¸Œæœ›å¾—åˆ°çš„è¾“å‡ºä¸º
const vnode = {
    "tagName": "ul",
    "children": [
        {
            "tagName": "li",
            "children": [
                "åˆ—è¡¨1"
            ],
            "attributes": {}
        },
        {
            "tagName": "li",
            "children": [
                "åˆ—è¡¨2"
            ],
            "attributes": {}
        }
    ],
    "attributes": {
        "class": "\"list\""
    }
}
```
çœ‹èµ·æ¥ä»è¾“å…¥åˆ°è¾“å‡ºè¿˜æœ‰ä¸€å®šçš„è·ç¦»ï¼Œé‚£å°±å…ˆä»ç®€å•çš„å…¥æ‰‹ã€‚

##### 2.1 æ‹†è§£æ¨¡æ¿ç»“æ„

æ¨¡æ¿æœ‰ä¸‰ç§ç»“æ„ï¼šå¼€å§‹æ ‡ç­¾ã€ç»“æŸæ ‡ç­¾ã€æ–‡æœ¬å†…å®¹ã€‚

ç¬¬ä¸€æ­¥è¦åšçš„ï¼Œå°±æ˜¯å°†è¿™ä¸‰ç§ç»“æ„æ‹†åˆ†å‡ºæ¥ã€‚

å˜é‡ä»‹ç»ï¼šè¿™é‡Œä½¿ç”¨ word è¿™ä¸ªå…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰éå†åˆ°çš„ä¸å®Œæ•´çš„ç»“æ„ã€‚ä½¿ç”¨ stack å˜é‡æ¥è®°å½•æ‰€æœ‰ç›®å‰å¾—åˆ°çš„æ ‡ç­¾ã€‚

æ€è·¯ä»‹ç»ï¼š

-   åœ¨ä¸€ä¸ªæ ¼å¼æ­£ç¡®çš„æ¨¡æ¿ä¸­ï¼Œå½“é‡åˆ°ä¸€ä¸ª '<' ç¬¦å·ï¼Œé‚£æ„å‘³ç€ä¸€ä¸ªå¼€å§‹æ ‡ç­¾æˆ–ç»“æŸæ ‡ç­¾å‡ºç°äº†ï¼Œæ¢å¥è¯è¯´ï¼Œæ–‡æœ¬å†…å®¹ç»“æŸäº†ï¼Œè¿™æ—¶åº”è¯¥å°†å·²æœ‰å†…å®¹å‹å…¥æ ˆä¸­ï¼Œword æ¸…ç©ºå¹¶åˆå§‹åŒ–ä¸ºæœ€æ–°çš„å­—ç¬¦ '<'ã€‚[9-16è¡Œ]
-   é‡åˆ°ä¸€ä¸ª '>' ç¬¦å·ï¼Œè¯´æ˜ä¸€ä¸ªæ ‡ç­¾ç»“æŸäº†ï¼Œé‚£ä¹ˆå°† word += '>' åï¼Œæ¨å…¥æ ˆä¸­ï¼Œå¹¶æ¸…ç©º wordã€‚[3-8è¡Œ]
-   æ­¤å¤–å…¶ä»–ç¬¦å·ï¼Œéƒ½æ­£å¸¸å åŠ åœ¨ word ä¸Šå³å¯ã€‚

```js
for(let i = 0; i < tmpl.length; i += 1) {
  const char = tmpl[i]
  if (char === '>') {
    word += char
    word = word.trim()
    stack.push(word)
    word = ''
    // é‚£å°±ç»“æŸä¸€ä¸ªæ ‡ç­¾å•¦
  } else if (char === '<') {
    // å¿½ç•¥ç©ºå†…å®¹
    if(word.trim()) {
      stack.push(word.trim())
    }
    // æŠŠä¹‹å‰çš„å†…å®¹å‹å…¥æ ˆä¸­
    word = char
  } else {
    word += char
  }
}
```

åšå®Œè¿™ä¸€æ­¥ï¼Œå°±å¾—åˆ°äº†å¼€å§‹æ ‡ç­¾ã€å†…å®¹ã€ç»“æŸæ ‡ç­¾çš„åˆ—è¡¨ã€‚


<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f1b026de83745aa9c54555e3b13c6c4~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>


##### 2.2 è§£å†³çˆ¶å­å…³ç³»

ä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯æ€è€ƒï¼šåœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦èƒ½**è§£å†³çˆ¶å­å…³ç³»**ï¼Ÿ
è¿™é‡Œçš„è§£æ³•æ˜¯ï¼Œæ¯å‡ºç°ä¸€ä¸ª**ç»“æŸæ ‡ç­¾**ï¼Œåªè¦å¾€å‰æ‰¾ï¼Œæ‰¾åˆ°åå­—ç›¸åŒçš„æ ‡ç­¾ï¼Œé‚£å®ƒä»¬å°±å¯ä»¥æ„æˆä¸€ä¸ªèŠ‚ç‚¹ã€‚

*æ³¨æ„ï¼Œè¿™é‡Œåªè€ƒè™‘æœ‰å¼€å§‹æ ‡ç­¾å’Œé—­åˆæ ‡ç­¾çš„æƒ…å†µï¼Œä¸è€ƒè™‘å•æ ‡ç­¾ï¼ˆå¦‚ <input />ï¼‰ã€‚


æ€è·¯å¦‚ä¸‹ï¼š
- è§£æå¾—åˆ°æ ‡ç­¾å tagNameã€‚
- tagName å¦‚æœä»¥ '/' å¼€å¤´ï¼Œé‚£æ˜¯ä¸€ä¸ªç»“æŸæ ‡ç­¾ï¼Œå¦åˆ™æ˜¯ä¸€ä¸ªå¼€å§‹æ ‡ç­¾
  - å¯¹äºå¼€å§‹æ ‡ç­¾ï¼Œæ­£å¸¸ push è¿›å…¥ stack å³å¯
  - å¯¹äºç»“æŸæ ‡ç­¾ï¼Œåªéœ€è¦åœ¨ stack ä¸­ï¼ŒæŒ¨ä¸ª pop å‡ºæ¥ï¼Œæ¯”è¾ƒåå­—æ˜¯å¦ç›¸åŒã€‚
    - å¦‚æœä¸åŒï¼Œè¯´æ˜æ˜¯è¯¥ node çš„ã€Œå­èŠ‚ç‚¹ã€ï¼Œåªéœ€è¦å°†å…¶æ¨å…¥ children å±æ€§ä¸­å³å¯
    - å¦‚æœç›¸åŒï¼Œè¯´æ˜æ˜¯å¯¹åº”çš„ã€Œå¼€å§‹æ ‡ç­¾ã€ï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ª node çš„æ„å»ºå°±å®Œæˆäº†ã€‚å®Œæˆä¸€ä¸ª node åï¼Œéœ€è¦æ¨å›æ ˆä¸­ï¼Œå› ä¸ºå®ƒéœ€è¦ä½œä¸º children è¢«æŒ‚è½½åœ¨å¤–å±‚èŠ‚ç‚¹ã€‚


```js
  const tagName = word.slice(1, -1).split(' ')[0]
  if(tagName[0] === '/') {
    // å¦‚æœæ˜¯ä¸ªç»“æŸæ ‡ç­¾
    const endTag = tagName.slice(1)
    const node = {
      tagName: endTag,
      children: [],
    }
    while(stack.length) {
      const tag = stack.pop()
      if(typeof tag === 'string' && tag.slice(1, -1).split(' ')[0].trim()  === endTag.trim()) {
        // é‡åˆ°å¼€å§‹æ ‡ç­¾ï¼Œå®Œæˆ
        break
      } else {
        // æ³¨æ„æ ‡ç­¾çš„é¡ºåº
        node.children.unshift(tag)
      }
    }
    stack.push(node)
  } else {
    stack.push(word)
  }
```

ç»è¿‡è¿™ä¸€æ­¥ä¹‹åï¼Œå°±å¾—åˆ°äº†å…·æœ‰çˆ¶å­å…³ç³»çš„ vnode ç»“æ„ã€‚å¦‚ä¸‹ï¼š


<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebfe0724da6d4bbb8f10a50c5d350067~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>

##### 2.3 è§£æå¼€å§‹æ ‡ç­¾ä¸­çš„å±æ€§

æ—¢ç„¶ attributes å­˜åœ¨äºå¼€å§‹æ ‡ç­¾ä¸­ï¼Œé‚£å°±åœ¨é‡åˆ°å¼€å§‹æ ‡ç­¾æ—¶è¿›è¡Œè§£ææ“ä½œï¼Œå³ä¸Šè¿°ä»£ç  [12è¡Œ] ä¹‹å‰æ’å…¥è§£æå‡½æ•°ï¼Œè¿”å›è§£æç»“æœã€‚

è§£æå‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸º node èŠ‚ç‚¹å’Œ å¼€å§‹æ ‡ç­¾åŸå§‹æ–‡æœ¬ rawTagã€‚

ä¾‹å¦‚ï¼šæ ¹æ® rawTag å†…å®¹è¿›è¡Œå±æ€§è§£æï¼Œç»“æœå­˜æ”¾åœ¨ node.attributes ä¸­ã€‚ä»¥ rawTag = '<button @click="reduceNum2">' ä¸ºä¾‹ï¼Œå¾—åˆ°çš„ç»“æœåº”ä¸º attributes: {@click: '"addNum1"'}ã€‚

æ€è·¯å¦‚ä¸‹ï¼š
- ç”±äº attributes çš„å€¼å¯èƒ½å­˜åœ¨ç©ºæ ¼ï¼Œæ¯”å¦‚ v-for="item in items"ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ç©ºæ ¼è¿›è¡Œåˆ‡å‰²
- éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œè®°å½•åŒå¼•å·å‡ºç°çš„çŠ¶æ€ã€‚è‹¥å‡ºç°ç©ºæ ¼ï¼Œä½†å¼•å·å¤„äºæœªé—­åˆçŠ¶æ€ï¼Œå¿½ç•¥è¿™ä¸ªç©ºæ ¼ï¼›è‹¥å¼•å·é—­åˆï¼Œåˆ™ä¸ºä¸€ä¸ª ç‹¬ç«‹çš„å±æ€§ã€‚


```js
function parseAttributes(node, rawTag) {
  const tag = rawTag.slice(1, -1)
  // ä¸èƒ½ä½¿ç”¨ç©ºæ ¼ä½œä¸ºåˆ†å‰²ç¬¦ï¼Œå› ä¸ºéœ€è¦å¿½ç•¥åŒå¼•å·å†…çš„ç©ºæ ¼ quetos
  // é”™è¯¯å†™æ³•ï¼šconst attributes = tag.slice(1, -1).split(' ').slice(1).filter((attr) => attr.trim())

  let inQuotes = false // æ˜¯å¦å‡ºç°ä¸€ä¸ªæœªé—­åˆçš„å¼•å·
  let attr = ''
  const attributes = []
  for(const char of tag) {
    if(char === ' ') {
      // å‡ºç°ç©ºç™½
      if(inQuotes) {
        // åˆšåˆšå‡ºç°ä¸€ä¸ªæ²¡åŒ¹é…çš„å¼•å·ï¼Œé‚£ä¸ç®¡è¿™ä¸ªç©ºæ ¼
        attr += char
      } else {
        // è¿‡æ»¤æ‰ç©ºçš„ attr
        attr.trim() && attributes.push(attr.trim())
        attr = '' // æ¸…ç©º
      }
    } else {
      attr += char
      if(char === '"') { // é‡åˆ° " ç¬¦å·ï¼Œåˆ‡æ¢ inQuotes çŠ¶æ€
        inQuotes = !inQuotes
      }
    }
  }
  // å­˜å…¥æœ€åä¸€ä¸ªç»“æœ
  attr.trim() && attributes.push(attr.trim())
  // å°† attributes åˆ—è¡¨å­˜å…¥ node.attributes å±æ€§ä¸­
  for(const attr of attributes) {
    if(attr.indexOf('=') === -1) continue
    const key = attr.split('=')[0]
    const val = attr.split('=')[1]
    node.attributes[key] = val
  }
  return node
}
```

attributes å¤„ç†ç»“æœå¦‚ä¸‹ï¼š

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ac56a27c78c4e17b44e84e5ffa9977b~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>

##### 2.4 å°ç»“


æ€»ç»“ä¸‹æ¨¡æ¿å­—ç¬¦ä¸²è§£æä¸ºè™šæ‹Ÿ DOM çš„ä¸‰ä¸ªæ­¥éª¤ï¼š
- å…ˆæ‹†åˆ†æ ‡ç­¾å’Œæ–‡æœ¬å†…å®¹ã€‚
- å†ç»†åŒ–æ ‡ç­¾ï¼ŒåŒºåˆ†æ˜¯å¼€å§‹æ ‡ç­¾è¿˜æ˜¯ç»“æŸæ ‡ç­¾ã€‚
  - å¼€å§‹æ ‡ç­¾ç›´æ¥æ¨å…¥æ ˆä¸­
  - ç»“æŸæ ‡ç­¾å°±å¾€å‰æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°åŒåçš„å¼€å§‹æ ‡ç­¾ï¼Œå®Œæˆäº†èŠ‚ç‚¹çš„æ„å»ºæ¨å›æ ˆä¸­
- å¤„ç†å¼€å§‹æ ‡ç­¾ä¸­çš„å±æ€§ï¼Œæ·»åŠ åˆ°è™šæ‹Ÿ DOM çš„ attributes å±æ€§ä¸­


å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```js
function genVnode(tmpl) {
  const stack = []
  let word = ''
  for(let i = 0; i < tmpl.length; i += 1) {
    const char = tmpl[i]
    if (char === '>') {
      word += char
      word = word.trim()
      if(word) {
        // å¦‚æœ trim åä¸ºç©ºç™½ï¼Œç›´æ¥è·³è¿‡
        const tagName = word.slice(1, -1).split(' ')[0] // è¿˜éœ€è¦è€ƒè™‘æœ‰attrçš„æƒ…å†µ
        if(tagName[0] === '/') {
          // å¦‚æœæ˜¯ä¸ªç»“æŸæ ‡ç­¾
          const endTag = tagName.slice(1)
          let node = {
            tagName: endTag,
            children: [],
            attributes: {}
          }
          while(stack.length) {
            const tag = stack.pop()
            if(typeof tag === 'string' && tag.slice(1, -1).split(' ')[0].trim()  === endTag.trim()) {
              // æ‰¾åˆ°äº†å¯¹åº”çš„å¼€å§‹æ ‡ç­¾ï¼Œè§£æ attributes
              node = parseAttributes(node, tag)
              // å®Œæˆ
              break
            } else {
              // æ³¨æ„æ ‡ç­¾çš„é¡ºåº
              node.children.unshift(tag)
            }
          }

          if(getType(node) === 'Array') {
            stack.push(...node)
          } else {
            stack.push(node)
          }
          
        } else {
          stack.push(word)
        }
      }
      word = ''
      // é‚£å°±ç»“æŸä¸€ä¸ªæ ‡ç­¾å•¦
    } else if (char === '<') {
      if(word.trim()) {
        stack.push(word.trim())
      }
      // æŠŠä¹‹å‰çš„å†…å®¹å‹å…¥æ ˆä¸­
      word = char
    } else {
      word += char
    }
  }
  return stack[0] // å› ä¸ºè¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚æ ¹æ® vue æ¨¡æ¿åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹çš„è¦æ±‚ï¼Œè¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³å¯
}

function parseAttributes(node, rawTag) {
  const tag = rawTag.slice(1, -1)
  // ä¸èƒ½ä½¿ç”¨ç©ºæ ¼ä½œä¸ºåˆ†å‰²ç¬¦ï¼Œå› ä¸ºéœ€è¦å¿½ç•¥åŒå¼•å·å†…çš„ç©ºæ ¼ quetos
  // é”™è¯¯å†™æ³•ï¼šconst attributes = tag.slice(1, -1).split(' ').slice(1).filter((attr) => attr.trim())

  let inQuotes = false // æ˜¯å¦å‡ºç°ä¸€ä¸ªæœªé—­åˆçš„å¼•å·
  let attr = ''
  const attributes = []
  for(const char of tag) {
    if(char === ' ') {
      // å‡ºç°ç©ºç™½
      if(inQuotes) {
        // åˆšåˆšå‡ºç°ä¸€ä¸ªæ²¡åŒ¹é…çš„å¼•å·ï¼Œé‚£ä¸ç®¡è¿™ä¸ªç©ºæ ¼
        attr += char
      } else {
        // è¿‡æ»¤æ‰ç©ºçš„ attr
        attr.trim() && attributes.push(attr.trim())
        attr = '' // æ¸…ç©º
      }
    } else {
      attr += char
      if(char === '"') { // é‡åˆ° " ç¬¦å·ï¼Œåˆ‡æ¢ inQuotes çŠ¶æ€
        inQuotes = !inQuotes
      }
    }
  }
  // å­˜å…¥æœ€åä¸€ä¸ªç»“æœ
  attr.trim() && attributes.push(attr.trim())
  // å°† attributes åˆ—è¡¨å­˜å…¥ node.attributes å±æ€§ä¸­
  for(const attr of attributes) {
    if(attr.indexOf('=') === -1) continue
    const key = attr.split('=')[0]
    const val = attr.split('=')[1]
    node.attributes[key] = val
  }
  return node
}
```
---
#### Step 3ï¼šä»è™šæ‹Ÿ DOM åˆ°çœŸå® DOM

è™šæ‹Ÿ DOM æ ‘ï¼Œå…¶å®å°±æ˜¯å¤šå‰æ ‘ã€‚ç†Ÿæ‚‰äºŒå‰æ ‘çš„æœ‹å‹ï¼Œåº”è¯¥å¾ˆå®¹æ˜“æƒ³åˆ°é€’å½’ã€‚æˆ‘ä»¬åªè¦è§£å†³ä¸€ä¸ªå±‚çº§çš„é—®é¢˜ï¼Œå‰©ä¸‹çš„äº¤ç»™é€’å½’æ¥åšå°±å¥½å•¦ã€‚

ç”±äºåˆ›å»ºèŠ‚ç‚¹è¿˜æ¯”è¾ƒå¤æ‚ï¼Œä½¿ç”¨å‡½æ•°åŒ…è£…ä¸€ä¸‹~
- å¦‚æœæ˜¯æ ‡ç­¾èŠ‚ç‚¹ï¼Œéœ€è¦å¤„ç†å±æ€§ï¼Œè¿™é‡Œå¤„ç†äº† classï¼Œstyle å’Œ @å¼€å¤´çš„äº‹ä»¶ç›‘å¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚
- å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œéœ€è¦å…³æ³¨æ˜¯å¦å­˜åœ¨ mustache è¯­æ³•ï¼Œå¹¶è¿›è¡Œæ›¿æ¢å’Œè¿½è¸ªã€‚è¿™é‡Œå…ˆä¸å±•å¼€ï¼Œå°†åœ¨ Step4-5ä¸­ä»‹ç»ã€‚

```js
function createOneNode (vnode) {
  // 1ã€éæ–‡æœ¬èŠ‚ç‚¹
  const tag = vnode.tagName
  if(tag) {
    const node = document.createElement(tag)
    // å°† class åŠ ä¸Š
    if(vnode.attributes && vnode.attributes.class) {
      node.classList.add(vnode.attributes.class.slice(1, -1))
    }
    // å°† style åŠ ä¸Š
    if(vnode.attributes && vnode.attributes.style) {
      node.style.cssText += vnode.attributes.style.slice(1, -1)
    }

    // å°† äº‹ä»¶ç›‘å¬ åŠ ä¸Š
    if(vnode.attributes) {
      for(const key in vnode.attributes) {
        const val = vnode.attributes[key];
        if(key[0] === '@') {
          const handlerName = val.slice(1, -1)
          node.addEventListener(key.slice(1), function() {
            methods[handlerName].call(data)
          })
        }
      }
    }
    return node
  }
  // 2ã€æ–‡æœ¬èŠ‚ç‚¹
  const node = document.createTextNode(vnode) 
  return node
}
```

è¿˜æœ‰æ¯”è¾ƒå‡†ç¡®çš„ï¼Œè·å–å¯¹è±¡ç±»å‹çš„å‡½æ•°ï¼š

```js
  function getType(target) {
    return Object.prototype.toString.call(target).slice(8, -1)
  }
```


ä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚å› ä¸ºè¦ä½¿ç”¨é€’å½’ï¼Œé‚£ä¹ˆä¼ è¿›æ¥çš„å‚æ•°ï¼Œå¯èƒ½æ˜¯æ•°ç»„ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯¹è±¡ã€æ–‡æœ¬ï¼Œéœ€è¦åŒºåˆ†ã€‚
- ä¼ è¿›æ¥çš„ vnode æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆå¯¹æ•°ç»„çš„æ¯ä¸€é¡¹ï¼Œä½¿ç”¨ createRealDom åˆ›å»ºèŠ‚ç‚¹ï¼Œå¹¶æ¨åˆ° realDom åˆ—è¡¨ä¸­
- ä¼ è¿›æ¥çš„ vnode æ˜¯å¯¹è±¡æˆ–æ–‡æœ¬ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚
  - å¦‚æœ vnode æœ‰ childrenï¼Œå¯¹ children é€’å½’ä½¿ç”¨ createRealDomï¼Œå°†è¿”å›çš„ç»“æœï¼Œä½¿ç”¨ DOM API ï¼š appendChild æŒ‚è½½åˆ°åˆšåˆšåˆ›å»ºçš„æ–°èŠ‚ç‚¹ä¸Šã€‚
- è¿”å› realDom ç»“æœ


```js
  function createRealDom(vnode) {
    // å¯èƒ½æ˜¯å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æ•°ç»„
    let realDom = undefined
    if(getType(vnode) === 'Array') {
      // æ•°ç»„ç±»å‹
      realDom = []
      for(const item of vnode) {
        realDom.push(createRealDom(item))
      }
    } else {
      // å¯¹è±¡æˆ–è€…æ–‡æœ¬ç±»å‹
      realDom = createOneNode(vnode)
      if(vnode.children) {
        // children è¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨
        const childlist = createRealDom(vnode.children)
        // è¿”å›å­©å­åˆ—è¡¨ï¼Œå¹¶æŒ‚è½½åˆ°çœŸå® dom ä¸Š
        for(const child of childlist) {
          realDom.appendChild(child)
        }
      }
    } 
    return realDom
  }
```

è¿™ä¸€æ­¥ï¼Œç”±ã€Œè™šæ‹Ÿ DOMã€å¾—åˆ°ã€ŒçœŸå® DOMã€çš„ç»“æœï¼Œå¦‚ä¸‹ï¼š



<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67d6f221b7f543cb94700cf9ff394c03~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>

---

#### Step 4ï¼šå°† data æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­
ç¬¬ 4-5 æ­¥ï¼Œå’Œå‰é¢çš„å‡½æ•°æœ‰ä¸€äº›å…³è”ï¼Œåœ¨å…¶å…³é”®æ­¥éª¤ä¸Šï¼ˆcreateOneNodeå‡½æ•°ï¼‰åŠ å…¥äº† mustache è¯­æ³•çš„è¯†åˆ«å’Œæ›¿æ¢ï¼Œåœ¨è·å–æ•°æ®æ—¶åŠ¨æ€æ›´æ–°ç›¸å…³è”çš„ DOMã€‚

å‡è®¾æ¨¡æ¿ä¸­å­˜åœ¨ mustache è¯­æ³•ï¼Œæ¯”å¦‚ {{xxx}}  ï¼ŒæŒ‰ç…§ vue çš„è¯­æ³•ï¼Œå°±æ˜¯å°† xxx æ›¿æ¢ä¸º data.xxx çš„å€¼ã€‚è¿™é‡Œå…ˆå®ç°ï¼Œä¸€æ®µ html æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆä¸å¸¦æ ‡ç­¾çš„ï¼Œéƒ½æ˜¯ textnode ç±»å‹ï¼‰ä¼ å…¥åï¼Œè¯†åˆ« {{}} åŒæ‹¬å·ä¸­çš„å˜é‡ï¼Œå¹¶æ›¿æ¢ä¸º data ä¸­ç›¸åº”çš„å€¼ã€‚
- æ­£åˆ™åŒ¹é…æ‰€æœ‰çš„ {{}} ç±»å‹ï¼Œé€šè¿‡åŒ¹é…ç»“æœå¾—åˆ°æ•°æ®è¡¨è¾¾å¼
- é€šè¿‡ new Function(`with(data) { return ${key}}`)() çš„æ‰§è¡Œç»“æœï¼Œè·å–è¡¨è¾¾å¼æ‰§è¡Œç»“æœã€‚å‡½æ•°æ–‡æœ¬ä¸­çš„ with(data) å°†æ•°æ®é”å®šåœ¨ data ä¸­ï¼Œå› æ­¤èƒ½è·å–å¯¹åº”çš„å€¼ã€‚
- é€šè¿‡å­—ç¬¦ä¸² replace æ–¹æ³•ï¼Œå°† åŒ¹é…ç»“æœæ›¿æ¢ä¸ºæ•°æ®å¯¹åº” key çš„ value
- è¿”å›æ–°ç»“æœ


```js
function matchMustache(w, realDom) {
  // åŒ¹é…æ¯ä¸€å¯¹ {{}}ï¼Œå¹¶å°†å…¶ä¸­çš„å­—ç¬¦ä½œä¸º keyï¼ŒåŒ¹é…å¹¶æ›¿æ¢ data ä¸­å¯¹åº” key çš„å€¼
  // /\{\{(.*)\}\}/g è¿™ä¸ªä¸è¡Œï¼
  let word = w
  const exp = /\{\{(.+?)\}\}/g
  const matchs = word.match(exp) ?? []
  // ç„¶åè¿˜æ˜¯ç”¨æ­£åˆ™çš„æ›¿æ¢
  for(const match of matchs) {
    const key = match.slice(2,-2).trim()
    // ä½¿ mustache æ”¯æŒè¡¨è¾¾å¼ï¼Œç‚¹æ“ä½œ
    function getVal(){
      // ä¸ºäº†ç®€åŒ–å†™æ³•ï¼Œè¿™é‡Œçš„ data æ˜¯å…¨å±€å˜é‡
      let res = new Function(`with(data) { return ${key}}`)()
      if(typeof res === 'object'){
        res = JSON.stringify(res)
      }
      return res
    }
    const value = getVal()
    word = word.replace(match, value)
  }
  return word
}
```

é‚£ä¹ˆï¼Œmustache è¯­æ³•éœ€è¦åœ¨å“ªä¸ªç¯èŠ‚è¿›è¡Œè½¬æ¢å‘¢ï¼Ÿ è¿™é‡Œæ’åœ¨äº† createOneNode æ–¹æ³•ä¸­ï¼šå› ä¸ºåœ¨ç®€æ˜“ç‰ˆæœ¬ä¸­ï¼Œmustache è¯­æ³•åªä¼šå‡ºç°åœ¨çº¯æ–‡æœ¬èŠ‚ç‚¹ä¸­ã€‚

```js
  function createOneNode (vnode, collect = true) {
    // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯ç©ºçš„
    const tag = vnode.tagName
    if(tag) return document.createElement(tag)

    const node = document.createTextNode(vnode)
    // æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¯èƒ½æ¶‰åŠåˆ° mustache è½¬æ¢äº†
    // å¦‚æœåœ¨è¿™é‡Œè½¬åŒ– mustache è¯­æ³•ï¼Œä¼šä¸ä¼šæ›´å¥½æ”¶é›†ä¾èµ–
    
    const replaced = matchMustache(vnode, data, node, collect)
    node.nodeValue = replaced
    return node
  }
```

---
#### Step 5ï¼šå®ç° data å“åº”å¼æ›´æ–° ã€å·²å‚ç…§ã€Švue.jsçš„è®¾è®¡ä¸å®ç°ã€‹æ›´æ–°ã€‘

åœ¨ vue ä¸­ï¼Œéœ€è¦å“åº”å¼çš„åœºæ™¯ï¼ŒåŒ…æ‹¬æ¨¡æ¿æ¸²æŸ“ã€computedé€‰é¡¹ã€watché€‰é¡¹ã€å±æ€§æŒ‡ä»¤ç­‰ç­‰ã€‚ä¸ºç®€åŒ–ï¼Œè¿™é‡Œå…ˆå®ç°æ¨¡æ¿æ¸²æŸ“çš„å“åº”å¼æ›´æ–°ã€‚
è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š
- å“ªä¸ªæ•°æ®è¢«ä½¿ç”¨
- è°ä½¿ç”¨äº†æ•°æ®
- æ€ä¹ˆé€šçŸ¥ä½¿ç”¨æ–¹æ›´æ–°


##### 5.1 å“ªä¸ªæ•°æ®è¢«ä½¿ç”¨ï¼Ÿ

å…ˆè§£å†³ **ã€Œå“ªä¸ªæ•°æ®è¢«ä½¿ç”¨ã€** çš„é—®é¢˜ã€‚



ä»¥ä¸€ä¸ªæ ‘å½¢æ•°æ®ç»“æ„ä¸ºä¾‹ï¼šè®¿é—®äº† tree.left.valï¼Œå¦‚ä½•çŸ¥é“ç›®å‰è®¿é—®çš„æ˜¯ tree.left å¯¹è±¡ä¸­çš„ valï¼Œè€Œä¸æ˜¯ tree.val æˆ–è€… tree.right.val å‘¢ï¼Ÿ

```js
data() {
    tree: {
        val: '1',
        left: {
            val: '2',
            left: null,
            right: null,
        },
        right: {
            val: '3',
            left: null,
            right: null,
        },
    }
}
```



> (æ–¹æ¡ˆé€‰æ‹©éƒ¨åˆ†å¯ä»¥å¿½ç•¥ï¼Œåªçœ‹æœ€ç»ˆé€‰æ‹©çš„æ–¹æ¡ˆandæ–¹æ¡ˆç»†èŠ‚)
>
> **æˆ‘æƒ³åˆ°äº†ä¸¤ä¸ªæ–¹æ¡ˆ:**
> 
> æ–¹æ¡ˆä¸€ï¼šä¿å­˜å˜é‡çš„è·¯å¾„ 'tree.left.val'ï¼Œä½œä¸ºå¯¹åº”ä¾èµ–çš„ keyã€‚ç”±äºå¯¹è±¡ä¸­çš„ key ä¸ä¼šé‡å¤ï¼Œæ‰€ä»¥è·¯å¾„æ˜¯å¯ä»¥å”¯ä¸€åŒ¹é…ä¸€ä¸ªå˜é‡çš„ã€‚
> 
> æ–¹æ¡ˆäºŒï¼šä¿å­˜å¯¹è±¡å’Œå±æ€§åã€‚ç”±äºå¯¹è±¡çš„å¼•ç”¨æŒ‡å‘å”¯ä¸€ç¡®å®šçš„å¯¹è±¡ï¼Œè€ŒåŒä¸€å¯¹è±¡ä¸­çš„å±æ€§ä¹Ÿä¸ä¼šé‡å¤ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å”¯ä¸€åŒ¹é…ä¸€ä¸ªå¯¹è±¡ã€‚
> 
> 
> **é‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ¡ˆæ€ä¹ˆå–èˆå‘¢ï¼Ÿ**
> 
> æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹ proxy æä¾›äº†ä»€ä¹ˆæ ·çš„åŠŸèƒ½ã€‚å½“è®¿é—®ä¸€ä¸ª proxy å¯¹è±¡ä¸­çš„å±æ€§æ—¶ï¼Œä¼šè°ƒç”¨ get å‡½æ•°ï¼ŒåŒç†å½“è®¾ç½®å±æ€§å€¼æ—¶ï¼Œä¼šè°ƒç”¨ set å‡½æ•°ã€‚ä¼ å…¥è¿™ä¸¤ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ **å¯¹è±¡** å’Œ **å±æ€§**ã€‚
> 
> è¿™æ ·çš„ç‰¹æ€§å°±å¾ˆé€‚åˆä½¿ç”¨æ–¹æ¡ˆäºŒã€‚è€Œæ–¹æ¡ˆä¸€å°±ä¼šé¢ä¸´ç€æ— æ³•æ•æ‰ä¸Šä¸€å±‚çº§å˜é‡åç§°çš„é—®é¢˜ï¼Œæ¯”å¦‚è®¿é—®äº† tree.left.valï¼Œè€Œ get å‡½æ•°ä¸­ä¼ å…¥ tree.left å¯¹è±¡ å’Œ 'val' å±æ€§åï¼Œå¹¶æ— æ³•æ„ŸçŸ¥ã€‚



```js
const handler = {
    get(obj, property) {
      track(obj, property)
      return obj[property]
    },
    set(obj, property, value) {
      // é€šçŸ¥ä¹‹å‰æ”¶é›†çš„æ‰€æœ‰ä¾èµ–ï¼šæ›´æ–°ä¸€ä¸‹ç›¸å…³çš„å€¼å•¦ï¼
      obj[property] = value
      trigger(obj, property)
      return true
    }
 }
const data = new Proxy(rawData, handler)
```



çœ‹ä¸€ä¸‹æ–¹æ¡ˆäºŒçš„ç»†åŒ–ï¼š


è¿™é‡Œä½¿ç”¨ proxy å®ç°ï¼Œè¯­æ³•å¾ˆç®€å•ï¼Œè·Ÿ Object.defineProperty ç±»ä¼¼ï¼Œè®¾ç½®å±æ€§å¯¹åº”çš„ get å’Œ set åŠ¨ä½œå°±å¯ä»¥äº†ã€‚

åœ¨ get å’Œ set å‡½æ•°ä¸­ï¼Œå¯çŸ¥å½“å‰è®¿é—®çš„ å¯¹è±¡ targetå’Œ å±æ€§ propertyã€‚å› ä¸ºå­˜åœ¨å±æ€§é‡åçš„å¯èƒ½ï¼Œä¸ºäº†å‡†ç¡®å¾—åŒ¹é…åˆ°å±æ€§ï¼Œå¿…é¡»ä¿å­˜ target çš„æ˜ å°„ã€‚æ¯”å¦‚ obj1ã€obj2 ä¸­éƒ½å­˜åœ¨åä¸º nameï¼Œé€šè¿‡å…ˆæ˜ å°„åˆ°å¯¹è±¡ï¼Œå†æ˜ å°„åˆ°å±æ€§çš„æ–¹å¼ï¼Œæ‰èƒ½æ­£ç¡®åŒ¹é…ã€‚


åœ¨ get æ—¶æ”¶é›†ä¾èµ–ï¼Œset æ—¶é€šçŸ¥ä¾èµ–ï¼Œæ˜¯ç¬¬ 2ã€3æ­¥éœ€è¦è§£å†³çš„é—®é¢˜ã€‚

```js
const handler = {
    get(obj, property) {
      track(obj, property)
      return obj[property]
    },
    set(obj, property, value) {
      // é€šçŸ¥ä¹‹å‰æ”¶é›†çš„æ‰€æœ‰ä¾èµ–ï¼šæ›´æ–°ä¸€ä¸‹ç›¸å…³çš„å€¼å•¦ï¼
      obj[property] = value
      trigger(obj, property)
      return true
    }
 }
const data = new Proxy(rawData, handler)
```

ç”±äº proxy åªæ”¯æŒç¬¬ä¸€å±‚å±æ€§çš„ä»£ç†ï¼Œæ‰€ä»¥é‡åˆ°å±æ€§å€¼ä¸ºå¯¹è±¡æ—¶ï¼Œéœ€è¦é€’å½’çš„å°†æ•°æ®è½¬åŒ–ä¸º proxyã€‚

```js
function reactiveData(rawData) {
  // é€’å½’åœ°å°†æ•°æ®è½¬åŒ–ä¸ºå“åº”å¼
  function deepProxy(data) {
    const newData = new Proxy(data, handler)
    for(const key in newData) {
      const val = newData[key]
      if(typeof val === 'object') {
        newData[key] = deepProxy(newData[key])
      }
    }
    return newData
  }
  return deepProxy(rawData)
}
```



##### 5.2 è°ä½¿ç”¨äº†æ•°æ®ï¼Ÿ
æ¥ç€è§£å†³ **ã€Œè°ä½¿ç”¨äº†æ•°æ®ã€** çš„é—®é¢˜ã€‚å‚ç…§æºç ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨äº†æ•°æ®çš„å‡½æ•°æˆä¸ºã€Œå‰¯ä½œç”¨å‡½æ•°ã€ã€‚

åˆ©ç”¨**å…¨å±€å˜é‡**ï¼Œæˆ‘ä»¬å¯ä»¥å† get å‡½æ•°ä¸­æ„ŸçŸ¥å½“å‰çš„ã€Œå‰¯ä½œç”¨å‡½æ•°ã€ã€‚

åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°fnå‰ï¼Œå°†å…¨å±€å˜é‡ activeEffect æŒ‡å‘fnï¼Œç´§æ¥ç€è°ƒç”¨fnï¼Œç”±äºfnå°†è®¿é—®æ•°æ®ï¼Œè§¦å‘getå‡½æ•°æ‰§è¡Œï¼Œè¿™æ—¶å°±å¯ä»¥å°† activeEffect æ”¶é›†åˆ°å½“å‰æ•°æ®çš„ä¾èµ–ä¸­ã€‚

åˆ©ç”¨**é—­åŒ…**çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ä¿å­˜è¿™ä¸ªçš„å‡½æ•°å†æ¬¡è§¦å‘æ—¶ï¼Œå¯ä»¥ä¿æœ‰åŸæ¥çš„ä½œç”¨åŸŸï¼Œå¹¶ä¸”ä¸æ–°çš„æ•°æ®ç»“åˆè¿ç®—å‡ºæ›´æ–°åçš„ç»“æœã€‚

æˆ‘ä»¬ä½¿ç”¨ effect åŒ…è£…å‰¯ä½œç”¨å‡½æ•°ï¼Œè®©å‰¯ä½œç”¨å‡½æ•°ä¸éœ€è¦å…³æ³¨å…¨å±€å˜é‡èµ‹å€¼çš„ç»†èŠ‚ã€‚

```js
let activeEffect = ''
function effect(fn) {
    activeEffect = fn // å°†å‡½æ•°èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼Œè¿™æ · get å‡½æ•°ä¸­å°±èƒ½æ”¶é›†åˆ°è¿™ä¸ªå‡½æ•°
    fn()
    
    // å¯ä»¥ä¸ç”¨æ¸…ç©º activeEffect
    // æœ‰ä¾èµ–ï¼Œåˆ™ä¸€å®šèƒ½åˆ·æ–° activeEffect å‡½æ•°ï¼Œæ²¡æœ‰ä¾èµ–ï¼Œåˆ™ä¸ä¼šè§¦å‘getå‡½æ•°
    activeEffect = ''  
}
```

```js
// åœ¨ get æ—¶ä½¿ç”¨ track å‡½æ•°
// æˆ‘ä»¬å°†ç®€åŒ–ï¼Œå°† property ä½œä¸º keyï¼Œç»´æŠ¤å…¶ä¾èµ–å‡½æ•°é›†åˆ depsSetï¼Œset ç”¨äºå»é‡ï¼Œä¸ä¼šé‡å¤æ·»åŠ ä¾èµ–
const depsMap = new Map()
function track(property) {
    if (typeof property === 'string' && activeEffect) {
        let depsSet = depsMap.get(property)
        // å’Œè¿™ä¸ªå¯¹è±¡çš„è¿™ä¸ª property æœ‰å…³ç³»çš„ fn å°±è¢«æ·»åŠ åˆ°ä¾èµ–ä¸­äº†
        depsSet.add(activeEffect)
    }
}
```

ä»¥æ¨¡æ¿ç¼–è¯‘ä¸ºä¾‹ï¼Œæ•°æ®çš„ä½¿ç”¨ä¾¿æ˜¯ï¼šåœ¨ mustache åŒ¹é…æ—¶ä¼šè®¿é—® dataï¼Œè€Œä¸”æ­¤æ—¶ä¹Ÿå·²çŸ¥çœŸå® DOMï¼Œæ‰€ä»¥è¿™é‡Œå°†çœŸå® DOM ä½œä¸ºæ•°æ®ä½¿ç”¨æ–¹ã€‚
æµç¨‹å¦‚ä¸‹ï¼š
- å°†å½“å‰å¤„ç†èŠ‚ç‚¹è®¾ç½®ä¸ºå…¨å±€å˜é‡ realDomTargetï¼Œå’Œå¯¹åº”çš„åŸå§‹å†…å®¹ vnode ä¹Ÿè®¾ç½®ä¸ºå…¨å±€å˜é‡ wTarget [13-14è¡Œ]
- è¿è¡Œ matchMustache å‡½æ•°ï¼Œå½“æ–‡æœ¬èŠ‚ç‚¹å­˜åœ¨ mustache è¯­æ³•æ—¶ï¼Œä¼šè®¿é—® data ä¸­å¯¹åº”çš„å˜é‡ï¼Œ proxy ä¸­å¯¹åº” property çš„ get å‡½æ•°è¢«è§¦å‘
- Get å‡½æ•°é€šè¿‡ realDomTarget è·å¾—å½“å‰å¤„ç†çš„ DOM èŠ‚ç‚¹ï¼Œå¹¶å°† realDomTarget æ·»åŠ åˆ° å½“å‰ property çš„ä¾èµ–ä¸­
- å…¨å±€å˜é‡ realDomTarget ã€wTarget æ¢å¤ä¸ºåˆå§‹å€¼ï¼Œå¦åˆ™ä¼šåœ¨å…¶ä»–è®¿é—®æ•°æ®çš„æƒ…å¢ƒä¸‹è¢«è¯¯ç”¨ä¸ºä¾èµ– [20-21è¡Œ]

```js
function createOneNode (vnode) {
  // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¯èƒ½æ²¡æœ‰ tag
  
  const tag = vnode.tagName
  if(tag) {
    const node = document.createElement(tag)
    return node
  }

  const node = document.createTextNode(vnode)

  const replaced = matchMustache(vnode)
  node.nodeValue = replaced
  
  return node
}
```

æŒ‰ä¸Šè¿°åˆ†æï¼Œæ•°æ®ä¸­çš„ä¸€ä¸ª property å¯èƒ½å¯¹åº” å¤šä¸ª realDomï¼Œè€Œä¸€ä¸ª realDom ä¹Ÿå¯èƒ½ä½¿ç”¨äº† å¤šä¸ª propertyï¼Œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚è¿™é‡Œä½¿ç”¨ Map å­˜ä¸‹æ¯ä¸ª property å¯¹åº”çš„ realDom åˆ—è¡¨ï¼Œç»´æŠ¤è¿™æ ·çš„å…³ç³»ã€‚

```json
// Dep ç»“æ„å¦‚ä¸‹
{
    property1: [ realDom1, realDom2],
    property2: [realDom3, realDom1],
}
```

åœ¨ get æ—¶è¿è¡Œ track å‡½æ•°ï¼Œä¸ºå¯¹åº”çš„ property æ·»åŠ ä¾èµ–ã€‚

```js
function track(property) {
  if(typeof property === 'string' && realDomTarget) {
      if(!Dep[property]) {
        Dep[property] = []
      }
      // ä½¿ç”¨ map å‡å°‘é‡å¤æ“ä½œ
      let target = domTargetMap.get(realDomTarget)
      if(!target) {
        target = { w: wTarget,realDom: realDomTarget }
        domTargetMap.set(realDomTarget, target)
      }
      // è€Œä¸”æ˜¯æ²¡å­˜å‚¨è¿‡çš„ä¾èµ–
      if(Dep[property].indexOf(target) === -1) {
        Dep[property].push(target)
      }
  }
}
```


ä¸Šè¿°ä»£ç è¿è¡Œåï¼Œæ”¶é›†çš„ä¾èµ–ç»“æœå¦‚ä¸‹ã€‚å¯ä»¥çœ‹åˆ°é¼ æ ‡ç§»è‡³ realDom å±æ€§æ—¶ï¼Œé¡µé¢ä¸Šå¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹Ÿé«˜äº®äº†ï¼›ä½¿ç”¨ num1 æ•°æ®çš„ DOM èŠ‚ç‚¹å’ŒåŸå§‹æ¨¡æ¿å€¼ï¼Œéƒ½è¢«æ”¶é›†åœ¨ä»¥ num1 å¯¹åº”çš„æ•°ç»„ä¸­ï¼Œ num2 åŒç†ã€‚

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e033c486a16a409eae18ed6cb43d0a5d~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>

##### 5.3 æ€ä¹ˆé€šçŸ¥ä½¿ç”¨æ–¹æ›´æ–°ï¼Ÿ

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†å‰ä¸¤ä¸ªé—®é¢˜ï¼Œè¿˜å‰©ä¸‹ **ã€Œæ€ä¹ˆé€šçŸ¥ä½¿ç”¨æ–¹æ›´æ–°ã€** è¿™ä¸ªé—®é¢˜äº†ã€‚å½“æ•°æ®å‘ç”Ÿæ”¹åŠ¨æ—¶ï¼Œproxy ä¸­çš„ set å‡½æ•°è¢«è°ƒç”¨ï¼Œæ›´æ–° Dep ä¸­å¯¹åº” property çš„çœŸå® DOM åˆ—è¡¨å³å¯ã€‚

```js
function notify(property) {
  if(Dep[property]) {
      const deps = Dep[property].slice()
      // Dep[property] = []
      // dom å’Œ data æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œæ›´æ–°ä¸€ä¸ªï¼Œå¿…é¡»æ›´æ–°å…¶ä»–
      for(const dep of deps) {
        const realDom = dep.realDom
        // é‡æ–°è°ƒç”¨å‡½æ•°è®¡ç®—æ–°çš„ DOM èŠ‚ç‚¹å€¼
        const replaced = matchMustache(dep.w)
        // æ›´æ–°nodevalue
        realDom.nodeValue = replaced
      }
    }
}
```

ä¿®æ”¹æ•°æ®å‰ï¼š

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2742f008e7284734bafb362beda860e7~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>

ä¿®æ”¹æ•°æ®åï¼Œæ•°æ®å“åº”å¼æ›´æ–°ï¼š

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/406cefae249b4fcc8ded2b2ed76cad3e~tplv-k3u1fbpfcp-zoom-1.image" width="500"/>
---

#### Step 6ï¼šVue å®ä¾‹åˆå§‹åŒ–

æœ€åï¼Œå°†å‰é¢å‡ æ­¥ä¸²èµ·æ¥ï¼Œå°±å¯ä»¥å•¦~

```js
let data = undefined
let methods = undefined
const Dep = {} // ç”¨äºå­˜æ”¾ä¾èµ–çš„å¯¹è±¡
const domTargetMap = new Map()

function myVue(options) { 
  // è½¬æˆå…¨å±€å˜é‡åªæ˜¯ä¸ºäº†ä¾¿äºè·å–ï¼Œå‡å°‘ä»£ç é‡
  data = reactiveData(options.data())
  methods = options.methods
  this.data = data
  // è·å–æ¨¡æ¿ï¼Œç¼–è¯‘ä¸ºè™šæ‹Ÿ dom
  const tmpl = options.template[0] === '#' ?  document.querySelector(options.template).innerHTML : options.template
  // æŠŠhtmlå­—ç¬¦ä¸²è½¬åŒ–è™šæ‹Ÿdom
  const vnode = genVnode(tmpl)
  // ä½¿ç”¨è™šæ‹Ÿdomåˆ›å»ºçœŸå®domæ ‘
  const fragment = document.createDocumentFragment() // fragmentç”¨æ¥æ¥æ”¶æ‰€æœ‰çš„ç»“æœï¼Œä¹‹åç»Ÿä¸€æŒ‚è½½åˆ°åº”ç”¨æ ¹èŠ‚ç‚¹ä¸Š
  const realDom = createRealDom(vnode) 
  fragment.appendChild(realDom)

  // å°† fragment æŒ‚è½½åˆ° app èŠ‚ç‚¹ä¸Š
  const app = document.querySelector(options.el || '#app')
  app.appendChild(fragment)
}
```
---
#### åè®°

è¿™éƒ¨åˆ†ä»£ç ä¹¦å†™ï¼Œå¹¶æ²¡æœ‰å®Œå…¨å‚ç…§æºç ï¼Œä¸€æ˜¯æºç å¤ªå¤æ‚ï¼Œæ²¡çœ‹å®Œï¼Œæ²¡çœ‹æ‡‚ QAQï¼›äºŒæ˜¯æœ¬æ¬¡ä¸»è¦æƒ³æ¢ç´¢ä¸‹å‰ç«¯æ¡†æ¶åŸç†ï¼Œé‡åœ¨ã€Œå¯ç”¨ã€å’Œã€Œç®€æ´ã€ï¼Œæ‰€ä»¥å®ç°äº†åŠŸèƒ½å°±æ²¡å¤ªçº ç»“äº vue æºç äº†ã€‚åç»­ä¼šç»§ç»­ç ”è¯»æºç ï¼Œç»§ç»­æ”¹è¿› ~

ğŸ”— ä»£ç é“¾æ¥ï¼šhttps://github.com/dandanDQ/blog

ğŸ”— ä½¿ç”¨ç¤ºä¾‹ï¼š https://jsbin.com/niyapom

